<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BITSAB X - Professional Crypto Exchange</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #f0b90b;
            --primary-dark: #e6ac00;
            --bg-dark: #0b0e15;
            --bg-card: #141a29;
            --bg-hover: #1c2539;
            --text-primary: #ffffff;
            --text-secondary: #848e9c;
            --text-green: #00b15d;
            --text-red: #ff5b5b;
            --border-color: #2a3244;
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading Skeletons */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-hover) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            min-height: 20px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Navbar */
        .navbar {
            background-color: var(--bg-card);
            padding: 0 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo i {
            font-size: 20px;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .currency-selector {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .currency-selector:hover {
            border-color: var(--primary);
        }

        .last-updated {
            color: var(--text-secondary);
            font-size: 13px;
            white-space: nowrap;
        }

        /* Main Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Chart Section */
        .chart-section {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .coin-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .coin-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .coin-name {
            font-size: 24px;
            font-weight: 600;
        }

        .coin-price {
            font-size: 32px;
            font-weight: 700;
            margin: 5px 0;
        }

        .price-change {
            font-size: 16px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        .positive {
            color: var(--text-green);
            background-color: rgba(0, 177, 93, 0.1);
        }

        .negative {
            color: var(--text-red);
            background-color: rgba(255, 91, 91, 0.1);
        }

        .timeframe-selector {
            display: flex;
            gap: 8px;
        }

        .timeframe-btn {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .timeframe-btn:hover {
            background-color: var(--bg-hover);
        }

        .timeframe-btn.active {
            background-color: var(--primary);
            color: var(--bg-dark);
            border-color: var(--primary);
        }

        .chart-container {
            height: 400px;
            margin-top: 20px;
            position: relative;
        }

        /* Market Table */
        .market-section {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .section-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-box {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            width: 200px;
            font-size: 14px;
            transition: var(--transition);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        .table-container {
            overflow-x: auto;
            max-height: 800px;
            overflow-y: auto;
        }

        .market-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }

        .market-table th {
            background-color: var(--bg-dark);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            text-align: left;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .market-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .market-table tbody tr {
            transition: var(--transition);
            cursor: pointer;
        }

        .market-table tbody tr:hover {
            background-color: var(--bg-hover);
        }

        .coin-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .coin-symbol {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .watchlist-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
            padding: 4px;
        }

        .watchlist-btn:hover {
            color: var(--primary);
        }

        .watchlist-btn.active {
            color: var(--primary);
        }

        /* Watchlist */
        .watchlist-section {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .watchlist-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 0 10px;
                flex-direction: column;
                height: auto;
                padding: 10px;
            }

            .nav-controls {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }

            .dashboard {
                padding: 10px;
                gap: 10px;
            }

            .chart-section, .market-section, .watchlist-section {
                padding: 15px;
            }

            .coin-price {
                font-size: 24px;
            }

            .timeframe-selector {
                flex-wrap: wrap;
                justify-content: center;
            }

            .chart-container {
                height: 300px;
            }

            .search-box {
                width: 150px;
            }
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .error-message {
            background-color: rgba(255, 91, 91, 0.1);
            border: 1px solid var(--text-red);
            color: var(--text-red);
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .success-message {
            background-color: rgba(0, 177, 93, 0.1);
            border: 1px solid var(--text-green);
            color: var(--text-green);
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 10px 0;
        }

        .refresh-button {
            background-color: var(--primary);
            color: var(--bg-dark);
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .refresh-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .price-update {
            animation: pulseUpdate 1s ease;
        }

        @keyframes pulseUpdate {
            0% { background-color: transparent; }
            50% { background-color: rgba(0, 177, 93, 0.2); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-coins"></i>
            <span>BITSAB X</span>
        </div>
        <div class="nav-controls">
            <select class="currency-selector" id="currencySelector">
                <option value="usd">USD ($)</option>
                <option value="bdt">BDT (৳)</option>
                <option value="inr">INR (₹)</option>
                <option value="eur">EUR (€)</option>
                <option value="gbp">GBP (£)</option>
                <option value="jpy">JPY (¥)</option>
            </select>
            <div class="last-updated" id="lastUpdated">
                Updated: Just now
            </div>
            <button class="refresh-button" id="refreshData">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </nav>

    <!-- Main Dashboard -->
    <main class="dashboard">
        <!-- Left Column: Chart -->
        <div class="left-column">
            <section class="chart-section">
                <div class="chart-header">
                    <div class="coin-info">
                        <div class="coin-icon" id="coinIcon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div>
                            <div class="coin-name" id="coinName">Bitcoin (BTC)</div>
                            <div class="coin-price" id="coinPrice">$0.00</div>
                            <div id="priceChange" class="price-change positive">+0.00% (24h)</div>
                        </div>
                    </div>
                    <div class="timeframe-selector">
                        <button class="timeframe-btn active" data-timeframe="1">1H</button>
                        <button class="timeframe-btn" data-timeframe="24">24H</button>
                        <button class="timeframe-btn" data-timeframe="168">7D</button>
                        <button class="timeframe-btn" data-timeframe="720">30D</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
                <div id="chartError" class="error-message hidden">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Unable to load chart data. Please try again later.</span>
                </div>
            </section>

            <!-- Watchlist -->
            <section class="watchlist-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-star"></i>
                        My Watchlist
                    </div>
                </div>
                <div id="watchlistContent">
                    <div class="watchlist-empty" id="emptyWatchlist">
                        <i class="fas fa-star" style="font-size: 32px; margin-bottom: 10px;"></i>
                        <p>Your watchlist is empty</p>
                        <p style="font-size: 13px; margin-top: 5px;">Click the star icon on any coin to add it here</p>
                    </div>
                    <div class="table-container hidden" id="watchlistTable">
                        <table class="market-table">
                            <thead>
                                <tr>
                                    <th>Coin</th>
                                    <th>Price</th>
                                    <th>24h Change</th>
                                    <th>Market Cap</th>
                                </tr>
                            </thead>
                            <tbody id="watchlistBody">
                                <!-- Watchlist items will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <!-- Right Column: Market Table -->
        <div class="right-column">
            <section class="market-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Top Cryptocurrencies
                    </div>
                    <input type="text" class="search-box" id="searchCoins" placeholder="Search coins...">
                </div>
                <div class="table-container">
                    <table class="market-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Coin</th>
                                <th>Price</th>
                                <th>24h Change</th>
                                <th>Market Cap</th>
                                <th>Volume (24h)</th>
                                <th><i class="fas fa-star"></i></th>
                            </tr>
                        </thead>
                        <tbody id="marketTableBody">
                            <!-- Loading skeletons -->
                            <tr><td colspan="7"><div class="skeleton" style="height: 400px;"></div></td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="marketError" class="error-message hidden">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Unable to load market data. Retrying in <span id="retryCount">20</span> seconds...</span>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Global variables
        let currentCurrency = 'usd';
        let currentCoinId = 'bitcoin';
        let currentTimeframe = 24;
        let chartInstance = null;
        let allCoins = [];
        let watchlist = JSON.parse(localStorage.getItem('bitsab_watchlist')) || [];
        let priceUpdateInterval;
        let lastUpdateTime = null;
        let currencySymbols = {
            usd: '$',
            bdt: '৳',
            inr: '₹',
            eur: '€',
            gbp: '£',
            jpy: '¥'
        };

        // DOM Elements
        const elements = {
            currencySelector: document.getElementById('currencySelector'),
            lastUpdated: document.getElementById('lastUpdated'),
            refreshData: document.getElementById('refreshData'),
            coinIcon: document.getElementById('coinIcon'),
            coinName: document.getElementById('coinName'),
            coinPrice: document.getElementById('coinPrice'),
            priceChange: document.getElementById('priceChange'),
            chartError: document.getElementById('chartError'),
            marketTableBody: document.getElementById('marketTableBody'),
            marketError: document.getElementById('marketError'),
            retryCount: document.getElementById('retryCount'),
            searchCoins: document.getElementById('searchCoins'),
            watchlistBody: document.getElementById('watchlistBody'),
            watchlistTable: document.getElementById('watchlistTable'),
            emptyWatchlist: document.getElementById('emptyWatchlist'),
            priceChart: document.getElementById('priceChart')
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
            loadMarketData();
            updateWatchlistDisplay();
            startAutoRefresh();
        });

        // Event Listeners
        function initializeEventListeners() {
            // Currency selector
            elements.currencySelector.addEventListener('change', (e) => {
                currentCurrency = e.target.value;
                updateCurrencyPrices();
                loadChartData(currentCoinId);
                updateLastUpdated();
            });

            // Timeframe buttons
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTimeframe = parseInt(btn.dataset.timeframe);
                    loadChartData(currentCoinId);
                });
            });

            // Refresh button
            elements.refreshData.addEventListener('click', () => {
                loadMarketData(true);
                loadChartData(currentCoinId);
            });

            // Search coins
            elements.searchCoins.addEventListener('input', debounce((e) => {
                filterCoins(e.target.value.toLowerCase());
            }, 300));

            // Watchlist star clicks (event delegation)
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('watchlist-btn') || 
                    e.target.closest('.watchlist-btn')) {
                    const btn = e.target.classList.contains('watchlist-btn') ? 
                        e.target : e.target.closest('.watchlist-btn');
                    const coinId = btn.dataset.coinId;
                    toggleWatchlist(coinId, btn);
                }
                
                // Row clicks for chart
                if (e.target.closest('tr') && e.target.closest('tbody')) {
                    const row = e.target.closest('tr');
                    const coinId = row.dataset.coinId;
                    if (coinId) {
                        loadChartData(coinId);
                        // Scroll to chart on mobile
                        if (window.innerWidth <= 768) {
                            document.querySelector('.chart-section').scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                }
            });
        }

        // Load market data from CoinGecko
        async function loadMarketData(forceRefresh = false) {
            try {
                elements.marketError.classList.add('hidden');
                
                if (forceRefresh) {
                    elements.marketTableBody.innerHTML = `
                        <tr><td colspan="7"><div class="skeleton" style="height: 400px;"></div></td></tr>
                    `;
                }

                const response = await fetch(
                    `https://api.coingecko.com/api/v3/coins/markets?vs_currency=${currentCurrency}&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h`
                );

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                allCoins = await response.json();
                renderMarketTable(allCoins);
                updateLastUpdated();
                
                // If no coin is selected yet, select the first one
                if (!currentCoinId || currentCoinId === 'bitcoin') {
                    loadChartData(allCoins[0].id);
                }

            } catch (error) {
                console.error('Error loading market data:', error);
                elements.marketError.classList.remove('hidden');
                
                // Start retry countdown
                let countdown = 20;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    elements.retryCount.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        loadMarketData();
                    }
                }, 1000);
            }
        }

        // Render market table
        function renderMarketTable(coins) {
            const tbody = elements.marketTableBody;
            tbody.innerHTML = '';

            coins.forEach((coin, index) => {
                const priceChange = coin.price_change_percentage_24h || 0;
                const isPositive = priceChange >= 0;
                const isInWatchlist = watchlist.includes(coin.id);

                const row = document.createElement('tr');
                row.dataset.coinId = coin.id;
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <div class="coin-cell">
                            <img src="${coin.image}" alt="${coin.name}" width="24" height="24" style="border-radius: 50%;">
                            <div>
                                <div>${coin.name}</div>
                                <div class="coin-symbol">${coin.symbol.toUpperCase()}</div>
                            </div>
                        </div>
                    </td>
                    <td class="price-cell" data-price="${coin.current_price}">
                        ${formatCurrency(coin.current_price)}
                    </td>
                    <td>
                        <span class="price-change ${isPositive ? 'positive' : 'negative'}">
                            ${isPositive ? '+' : ''}${priceChange.toFixed(2)}%
                        </span>
                    </td>
                    <td>${formatCurrency(coin.market_cap, true)}</td>
                    <td>${formatCurrency(coin.total_volume, true)}</td>
                    <td>
                        <button class="watchlist-btn ${isInWatchlist ? 'active' : ''}" 
                                data-coin-id="${coin.id}"
                                title="${isInWatchlist ? 'Remove from watchlist' : 'Add to watchlist'}">
                            <i class="fas fa-star"></i>
                        </button>
                    </td>
                `;
                
                // Add fade-in animation
                row.style.opacity = '0';
                tbody.appendChild(row);
                setTimeout(() => {
                    row.style.transition = 'opacity 0.3s ease';
                    row.style.opacity = '1';
                }, index * 20);
            });
        }

        // Load chart data
        async function loadChartData(coinId) {
            try {
                elements.chartError.classList.add('hidden');
                currentCoinId = coinId;
                
                // Find coin data
                const coin = allCoins.find(c => c.id === coinId) || allCoins[0];
                
                // Update coin info
                updateCoinInfo(coin);
                
                // Fetch historical data
                const days = currentTimeframe <= 24 ? 1 : currentTimeframe === 168 ? 7 : 30;
                const response = await fetch(
                    `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=${currentCurrency}&days=${days}`
                );

                if (!response.ok) throw new Error(`Chart API error: ${response.status}`);

                const data = await response.json();
                renderChart(data.prices, coin.name);

            } catch (error) {
                console.error('Error loading chart data:', error);
                elements.chartError.classList.remove('hidden');
            }
        }

        // Update coin information display
        function updateCoinInfo(coin) {
            if (!coin) return;

            // Update icon if available
            if (coin.image) {
                elements.coinIcon.innerHTML = `<img src="${coin.image}" alt="${coin.name}" width="24" height="24">`;
            }
            
            elements.coinName.textContent = `${coin.name} (${coin.symbol.toUpperCase()})`;
            
            // Animate price update
            elements.coinPrice.classList.remove('price-update');
            void elements.coinPrice.offsetWidth; // Trigger reflow
            elements.coinPrice.textContent = formatCurrency(coin.current_price);
            elements.coinPrice.classList.add('price-update');
            
            const priceChange = coin.price_change_percentage_24h || 0;
            const isPositive = priceChange >= 0;
            
            elements.priceChange.textContent = `${isPositive ? '+' : ''}${priceChange.toFixed(2)}% (24h)`;
            elements.priceChange.className = `price-change ${isPositive ? 'positive' : 'negative'}`;
        }

        // Render price chart
        function renderChart(prices, coinName) {
            const ctx = elements.priceChart.getContext('2d');
            
            // Destroy previous chart instance
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Prepare data
            const labels = [];
            const dataPoints = [];
            const firstPrice = prices[0][1];
            
            prices.forEach(([timestamp, price], index) => {
                // Format timestamp based on timeframe
                const date = new Date(timestamp);
                let label;
                
                if (currentTimeframe === 1) {
                    label = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else if (currentTimeframe === 24) {
                    label = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    label = date.toLocaleDateString([], { month: 'short', day: 'numeric' });
                }
                
                // Reduce number of labels for better readability
                if (index % Math.ceil(prices.length / 20) === 0 || index === prices.length - 1) {
                    labels.push(label);
                } else {
                    labels.push('');
                }
                
                dataPoints.push(price);
            });

            // Calculate chart color based on price movement
            const lastPrice = prices[prices.length - 1][1];
            const isPositive = lastPrice >= firstPrice;
            const chartColor = isPositive ? '#00b15d' : '#ff5b5b';

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, isPositive ? 'rgba(0, 177, 93, 0.2)' : 'rgba(255, 91, 91, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

            // Create chart
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${coinName} Price`,
                        data: dataPoints,
                        borderColor: chartColor,
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(20, 26, 41, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#2a3244',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${coinName}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(42, 50, 68, 0.3)' },
                            ticks: { color: '#848e9c' }
                        },
                        y: {
                            grid: { color: 'rgba(42, 50, 68, 0.3)' },
                            ticks: { 
                                color: '#848e9c',
                                callback: function(value) {
                                    return formatCurrency(value, false, true);
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    }
                }
            });
        }

        // Update prices when currency changes
        function updateCurrencyPrices() {
            // Update all price cells in market table
            document.querySelectorAll('.price-cell').forEach(cell => {
                const price = parseFloat(cell.dataset.price);
                cell.textContent = formatCurrency(price);
            });
            
            // Update watchlist if displayed
            updateWatchlistDisplay();
        }

        // Watchlist functionality
        function toggleWatchlist(coinId, button) {
            const index = watchlist.indexOf(coinId);
            
            if (index === -1) {
                // Add to watchlist
                watchlist.push(coinId);
                button.classList.add('active');
                showNotification('Added to watchlist');
            } else {
                // Remove from watchlist
                watchlist.splice(index, 1);
                button.classList.remove('active');
                showNotification('Removed from watchlist');
            }
            
            // Save to localStorage
            localStorage.setItem('bitsab_watchlist', JSON.stringify(watchlist));
            
            // Update watchlist display
            updateWatchlistDisplay();
        }

        // Update watchlist display
        function updateWatchlistDisplay() {
            if (watchlist.length === 0) {
                elements.emptyWatchlist.classList.remove('hidden');
                elements.watchlistTable.classList.add('hidden');
                return;
            }
            
            elements.emptyWatchlist.classList.add('hidden');
            elements.watchlistTable.classList.remove('hidden');
            
            // Get watchlist coins from allCoins
            const watchlistCoins = allCoins.filter(coin => watchlist.includes(coin.id));
            
            // Render watchlist table
            const tbody = elements.watchlistBody;
            tbody.innerHTML = '';
            
            watchlistCoins.forEach(coin => {
                const priceChange = coin.price_change_percentage_24h || 0;
                const isPositive = priceChange >= 0;
                
                const row = document.createElement('tr');
                row.dataset.coinId = coin.id;
                row.innerHTML = `
                    <td>
                        <div class="coin-cell">
                            <img src="${coin.image}" alt="${coin.name}" width="24" height="24" style="border-radius: 50%;">
                            <div>
                                <div>${coin.name}</div>
                                <div class="coin-symbol">${coin.symbol.toUpperCase()}</div>
                            </div>
                        </div>
                    </td>
                    <td>${formatCurrency(coin.current_price)}</td>
                    <td>
                        <span class="price-change ${isPositive ? 'positive' : 'negative'}">
                            ${isPositive ? '+' : ''}${priceChange.toFixed(2)}%
                        </span>
                    </td>
                    <td>${formatCurrency(coin.market_cap, true)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter coins based on search
        function filterCoins(searchTerm) {
            if (!searchTerm) {
                renderMarketTable(allCoins);
                return;
            }
            
            const filtered = allCoins.filter(coin => 
                coin.name.toLowerCase().includes(searchTerm) || 
                coin.symbol.toLowerCase().includes(searchTerm)
            );
            
            renderMarketTable(filtered);
        }

        // Format currency values
        function formatCurrency(value, isLargeNumber = false, isChart = false) {
            if (value === null || value === undefined) return 'N/A';
            
            const symbol = currencySymbols[currentCurrency] || '$';
            
            if (isLargeNumber) {
                // For market cap and volume
                if (value >= 1e12) {
                    return `${symbol}${(value / 1e12).toFixed(2)}T`;
                } else if (value >= 1e9) {
                    return `${symbol}${(value / 1e9).toFixed(2)}B`;
                } else if (value >= 1e6) {
                    return `${symbol}${(value / 1e6).toFixed(2)}M`;
                } else if (value >= 1e3) {
                    return `${symbol}${(value / 1e3).toFixed(2)}K`;
                }
            }
            
            // For regular prices
            if (value < 0.01) {
                return `${symbol}${value.toFixed(6)}`;
            } else if (value < 1) {
                return `${symbol}${value.toFixed(4)}`;
            } else if (value < 1000) {
                return `${symbol}${value.toFixed(2)}`;
            } else {
                return `${symbol}${value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            elements.lastUpdated.textContent = `Updated: ${timeString}`;
            lastUpdateTime = now;
        }

        // Start auto-refresh timer
        function startAutoRefresh() {
            clearInterval(priceUpdateInterval);
            
            priceUpdateInterval = setInterval(() => {
                loadMarketData();
                // Only refresh chart if it's been more than 2 minutes
                if (lastUpdateTime && (new Date() - lastUpdateTime) > 120000) {
                    loadChartData(currentCoinId);
                }
            }, 20000); // 20 seconds
        }

        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'success-message';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            `;
            notification.style.position = 'fixed';
            notification.style.top = '80px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.maxWidth = '300px';
            notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // Utility: Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initial chart load with Bitcoin
        setTimeout(() => {
            if (allCoins.length > 0) {
                loadChartData('bitcoin');
            }
        }, 1000);
    </script>
</body>
</html>